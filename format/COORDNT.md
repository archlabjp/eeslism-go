# COORDNT（座標変換・日射計算）

## 概要
COORDNT（Coordinate Transformation）は、建物や障害物の3次元座標を変換し、日射・日影計算を実行する中核的な計算エンジンです。複雑な建物形状、周辺障害物、樹木等の幾何学的関係を正確に処理し、各面への入射日射量、相互反射、形態係数を詳細に計算します。建物の環境性能評価において最も重要な計算プロセスを担います。

## 機能概要

### 主要機能
1. **座標変換処理**: 3次元座標系での幾何学計算
2. **日射計算**: 直達・散乱・反射日射の算出
3. **日影計算**: 障害物による影の投影計算
4. **形態係数計算**: 面間の幾何学的関係
5. **相互反射計算**: 多重反射による日射増加

### 処理対象
- **建物面**: 外壁、屋根、窓等の受光面
- **障害物**: 隣接建物、構造物（OBS）
- **樹木**: 植栽による日射遮蔽（TREE）
- **多角形**: 複雑形状の面（POLYGON）

## 計算プロセス

### 1. 幾何学的前処理
```
LP_COORDNT (Light-Receiving Plane Coordinate Transformation)
```
- **面の定義**: 各面の頂点座標から法線ベクトル・中心点を計算
- **座標変換**: 建物座標系から計算座標系への変換
- **面積計算**: 各面の正確な面積算出

### 2. 太陽位置計算
- **太陽軌道**: 日時・緯度・経度から太陽位置を算出
- **日射成分**: 直達・散乱・地面反射日射の分離
- **大気透過率**: 大気による日射減衰の考慮

### 3. 日影投影計算
- **影の形状**: 障害物の3次元形状から影を投影
- **重複処理**: 複数障害物による影の重なり計算
- **時系列処理**: 太陽軌道に沿った連続的な影計算

### 4. 形態係数計算
```
形態係数 = 面Aから面Bを見込む立体角 / π
```
- **天空係数**: 各面から天空を見込む割合
- **地面係数**: 各面から地面を見込む割合
- **相互係数**: 面間の相互視認関係

### 5. 日射量計算
```
全日射量 = 直達日射 + 散乱日射 + 反射日射
```

#### 直達日射
```
直達日射 = 法線面直達日射 × cos(入射角) × (1 - 遮蔽率)
```

#### 散乱日射
```
散乱日射 = 水平面散乱日射 × 天空係数
```

#### 反射日射
```
反射日射 = Σ(隣接面日射量 × 反射率 × 形態係数)
```

## 座標系の定義

### 建物座標系
- **X軸**: 東方向が正
- **Y軸**: 北方向が正
- **Z軸**: 上方向が正
- **原点**: 建物基準点

### 面座標系
- **法線ベクトル**: 面に垂直で外向き
- **中心点**: 面の重心座標
- **面積**: 頂点座標から計算

## 入力データの処理

### 建物面データ（RMP）
```cpp
!  建物の外壁・屋根面
struct RMP_Data {
    string name;        !  面名称
    string wallname;    !  壁体名称
    vector<XYZ> points; !  頂点座標
    double ref;         !  反射率
    double area;        !  面積
}
```

### 障害物データ（OBS）
```cpp
!  外部障害物
struct OBS_Data {
    string name;        !  障害物名
    string shape;       !  形状タイプ
    XYZ position;       !  位置座標
    XYZ dimensions;     !  寸法
    double orientation; !  方位角
    vector<double> ref; !  各面反射率
}
```

### 樹木データ（TREE）
```cpp
!  樹木
struct TREE_Data {
    string name;        !  樹木名
    string type;        !  樹木タイプ
    XYZ position;       !  位置座標
    double trunk_dia;   !  幹直径
    vector<double> canopy_width;  !  葉部幅
    vector<double> canopy_height; !  葉部高さ
}
```

## 計算精度の制御

### 分割精度
- **面分割**: 大きな面の適切な分割
- **時間分割**: 日射計算の時間間隔
- **角度分割**: 形態係数計算の角度精度

### 収束判定
- **反射計算**: 多重反射の収束条件
- **影計算**: 影境界の精度設定
- **積分計算**: 数値積分の精度制御

## 計算結果の出力

### 面別日射量
```
各面の時刻別日射量:
- 直達日射量 [W/m²]
- 散乱日射量 [W/m²]  
- 反射日射量 [W/m²]
- 全日射量 [W/m²]
```

### 遮蔽効果
```
日射遮蔽率:
- 障害物別遮蔽率 [%]
- 樹木別遮蔽率 [%]
- 総合遮蔽率 [%]
```

### 形態係数
```
幾何学的関係:
- 天空係数 [-]
- 地面係数 [-]
- 相互形態係数 [-]
```

## 計算の最適化

### 効率化手法
1. **可視性判定**: 見えない面の計算省略
2. **距離判定**: 影響の小さい遠方要素の簡略化
3. **対称性利用**: 対称形状での計算量削減
4. **並列処理**: 独立計算の並列実行

### メモリ管理
- **動的配列**: 必要に応じたメモリ確保
- **キャッシュ**: 繰り返し計算結果の保存
- **ガベージコレクション**: 不要データの自動削除

## 検証とデバッグ

### 計算検証
1. **エネルギー保存**: 入射・反射・吸収の収支確認
2. **幾何学検証**: 形態係数の和の確認
3. **対称性確認**: 対称条件での結果一致
4. **既知解比較**: 単純形状での理論解比較

### デバッグ機能
- **中間結果出力**: 計算過程の詳細表示
- **可視化出力**: 3次元形状の確認
- **ログ出力**: 計算手順の記録

## 応用例

### 建物設計最適化
```
日射制御設計:
- 庇・ルーバーの効果検証
- 建物配置の最適化
- 開口部設計の評価
```

### 都市環境評価
```
都市計画支援:
- 日影規制の確認
- ヒートアイランド評価
- 風環境との連成解析
```

### 省エネルギー設計
```
エネルギー性能評価:
- 冷暖房負荷の算出
- 昼光利用の評価
- 太陽光発電量の予測
```

## 計算限界と注意事項

### 計算精度の限界
1. **複雑形状**: 極端に複雑な形状での近似誤差
2. **多重反射**: 高反射率での収束性
3. **微小面**: 極小面での数値誤差
4. **計算時間**: 高精度計算での処理時間増加

### 入力データの制約
1. **座標精度**: 測量精度による誤差
2. **材料特性**: 反射率等の物性値精度
3. **気象データ**: 日射量データの精度
4. **形状近似**: 複雑形状の近似による誤差

## 関連データセット

- [OBS](OBS.md): 外部障害物の定義
- [TREE](TREE.md): 樹木の定義
- [POLYGON](POLYGON.md): 多角形面の定義
- [SUNBRK](SUNBRK.md): 日除けの定義
- [WALL](WALL.md): 壁体材料特性
- [EXSRF](EXSRF.md): 外表面・方位定義

## 技術仕様

### 計算精度
- **座標精度**: 小数点以下3桁（mm単位）
- **角度精度**: 小数点以下1桁（0.1度単位）
- **日射精度**: 小数点以下1桁（0.1W/m²単位）

### 処理能力
- **最大面数**: 10,000面程度
- **最大障害物数**: 1,000個程度
- **計算時間**: 年間計算で数分～数時間

### システム要件
- **メモリ**: 最低4GB、推奨8GB以上
- **CPU**: マルチコア推奨
- **ストレージ**: 計算結果保存用の十分な容量