# DIVID（計算領域分割）

## 概要
DIVID（Division）は、複雑な建物形状や大規模な計算領域を効率的に処理するための領域分割機能です。建物や敷地を適切な計算単位に分割することで、メモリ使用量の最適化、計算時間の短縮、並列処理の効率化を実現します。特に大規模建築や複数建物の同時解析において、計算性能の向上に重要な役割を果たします。

## 機能概要

### 主要機能
1. **空間分割**: 3次元空間の効率的な分割
2. **負荷分散**: 計算負荷の均等分散
3. **メモリ最適化**: メモリ使用量の削減
4. **並列処理**: マルチコア・分散処理の支援
5. **境界処理**: 分割境界での連続性確保

### 分割対象
- **建物領域**: 大規模建築の室・ゾーン分割
- **外部領域**: 敷地・周辺環境の分割
- **計算格子**: CFD等の格子分割
- **時間領域**: 長期間計算の時間分割

## データ形式
```
DIVID
    <分割名>
        type=<分割タイプ>
        method=<分割手法>
        nx=<X方向分割数> ny=<Y方向分割数> nz=<Z方向分割数>
        xmin=<X最小値> xmax=<X最大値>
        ymin=<Y最小値> ymax=<Y最大値>
        zmin=<Z最小値> zmax=<Z最大値>
        overlap=<重複幅>
        balance=<負荷バランス手法>
    ;
    ... 繰り返し
*
```

## パラメータ説明

| パラメータ | 単位 | 説明 | デフォルト値 | 参照 |
|:---|:---|:---|:---|:---|
| 分割名 | - | 分割設定の識別名 | - | 必須 |
| 分割タイプ | - | 分割の種類（SPATIAL/TEMPORAL） | SPATIAL | 任意 |
| 分割手法 | - | 分割アルゴリズム | UNIFORM | 任意 |
| X方向分割数 | - | X軸方向の分割数 | 1 | 任意 |
| Y方向分割数 | - | Y軸方向の分割数 | 1 | 任意 |
| Z方向分割数 | - | Z軸方向の分割数 | 1 | 任意 |
| X最小値 | m | 分割領域のX座標最小値 | - | 任意 |
| X最大値 | m | 分割領域のX座標最大値 | - | 任意 |
| Y最小値 | m | 分割領域のY座標最小値 | - | 任意 |
| Y最大値 | m | 分割領域のY座標最大値 | - | 任意 |
| Z最小値 | m | 分割領域のZ座標最小値 | - | 任意 |
| Z最大値 | m | 分割領域のZ座標最大値 | - | 任意 |
| 重複幅 | m | 隣接領域との重複幅 | 0.0 | 任意 |
| 負荷バランス手法 | - | 負荷分散の方法 | AUTO | 任意 |

## 分割タイプ一覧

| タイプ | 説明 | 用途 | 特徴 |
|:---|:---|:---|:---|
| `SPATIAL` | 空間分割 | 大規模建物・敷地 | 3次元空間の分割 |
| `TEMPORAL` | 時間分割 | 長期間計算 | 計算期間の分割 |
| `ADAPTIVE` | 適応分割 | 複雑形状 | 形状に応じた分割 |
| `HIERARCHICAL` | 階層分割 | マルチスケール | 階層的な分割 |

## 分割手法一覧

| 手法 | 説明 | 適用場面 | 特徴 |
|:---|:---|:---|:---|
| `UNIFORM` | 均等分割 | 規則的な形状 | 等間隔分割 |
| `ADAPTIVE` | 適応分割 | 複雑形状 | 形状適応分割 |
| `LOAD_BALANCED` | 負荷均等分割 | 並列処理 | 計算負荷均等化 |
| `OCTREE` | 八分木分割 | 3次元空間 | 階層的分割 |

## 使用例

### 基本的な空間分割
```
DIVID
    BuildingSpatialDivision
        type=SPATIAL
        method=UNIFORM
        nx=4 ny=3 nz=2
        xmin=0.0 xmax=100.0
        ymin=0.0 ymax=75.0
        zmin=0.0 zmax=20.0
        overlap=1.0
        balance=AUTO ;
*
```

### 大規模建築の分割
```
DIVID
    LargeBuilding
        type=SPATIAL
        method=ADAPTIVE
        nx=8 ny=6 nz=4
        xmin=-50.0 xmax=150.0
        ymin=-30.0 ymax=120.0
        zmin=0.0 zmax=60.0
        overlap=2.0
        balance=LOAD_BALANCED ;
*
```

### 時間領域分割
```
DIVID
    AnnualCalculation
        type=TEMPORAL
        method=UNIFORM
        nx=12 ny=1 nz=1
        overlap=24.0
        balance=AUTO ;
*
```

### 複合分割
```
DIVID
    ComplexDivision
        type=SPATIAL
        method=HIERARCHICAL
        nx=6 ny=4 nz=3
        xmin=0.0 xmax=200.0
        ymin=0.0 ymax=150.0
        zmin=0.0 zmax=80.0
        overlap=1.5
        balance=LOAD_BALANCED ;
    
    DetailedZone
        type=SPATIAL
        method=OCTREE
        nx=16 ny=12 nz=8
        xmin=50.0 xmax=100.0
        ymin=40.0 ymax=80.0
        zmin=10.0 zmax=30.0
        overlap=0.5
        balance=ADAPTIVE ;
*
```

## 分割戦略

### 空間分割の考慮事項
1. **建物形状**: 建物の幾何学的特徴に応じた分割
2. **計算密度**: 詳細計算が必要な領域の細分化
3. **境界条件**: 分割境界での物理的連続性
4. **メモリ制約**: 利用可能メモリに応じた分割サイズ

### 負荷分散の最適化
```
負荷バランス指標 = max(各領域の計算時間) / avg(各領域の計算時間)
```
理想的には1.0に近い値が望ましい。

## 境界処理

### 重複領域の設定
```
重複幅 = max(影響範囲, 数値誤差許容値)
```
- **熱伝導**: 熱拡散長さの2-3倍
- **日射計算**: 日射影響範囲
- **気流計算**: 乱流長さスケール

### 境界条件の継承
1. **温度**: 隣接領域からの温度境界条件
2. **流量**: 質量・エネルギー保存の確保
3. **日射**: 相互反射の連続性
4. **制御**: 制御信号の伝達

## 並列処理の最適化

### プロセス配置
```
DIVID
    ParallelProcessing
        type=SPATIAL
        method=LOAD_BALANCED
        nx=4 ny=2 nz=1  // 8プロセス並列
        balance=DYNAMIC ;
*
```

### 通信最適化
- **隣接通信**: 隣接領域間のデータ交換
- **集約通信**: 全体結果の集約
- **非同期通信**: 計算と通信の重複実行

## メモリ管理

### メモリ使用量の推定
```
メモリ使用量 = 基本データ + 計算データ + 通信バッファ
```

### 動的メモリ管理
- **オンデマンド**: 必要時のメモリ確保
- **プール**: メモリプールによる効率化
- **ガベージコレクション**: 不要データの自動削除

## 計算精度の確保

### 分割誤差の評価
1. **境界誤差**: 分割境界での不連続性
2. **収束性**: 分割数増加による解の収束
3. **保存性**: 物理量保存の確認

### 精度向上手法
- **高次補間**: 境界値の高精度補間
- **重複計算**: 境界近傍の重複計算
- **反復修正**: 境界条件の反復修正

## 性能評価指標

### 計算効率
```
並列効率 = (逐次計算時間) / (並列計算時間 × プロセス数)
```

### スケーラビリティ
```
スケーラビリティ = log(性能向上率) / log(プロセス数増加率)
```

### メモリ効率
```
メモリ効率 = (有効データサイズ) / (総メモリ使用量)
```

## 適用例

### 超高層建築
```
DIVID
    SkyscraperDivision
        type=SPATIAL
        method=ADAPTIVE
        nx=6 ny=6 nz=20  // 階層別分割
        overlap=1.0
        balance=LOAD_BALANCED ;
*
```

### 複合施設
```
DIVID
    ComplexFacility
        type=SPATIAL
        method=HIERARCHICAL
        nx=8 ny=6 nz=3
        overlap=2.0
        balance=DYNAMIC ;
*
```

### 都市街区
```
DIVID
    UrbanBlock
        type=SPATIAL
        method=OCTREE
        nx=16 ny=12 nz=4
        overlap=5.0
        balance=GEOGRAPHIC ;
*
```

## 設計指針

### 分割数の決定
1. **計算資源**: CPU数・メモリ容量に応じた分割
2. **問題規模**: 建物規模・計算精度要求
3. **通信コスト**: 分割による通信オーバーヘッド
4. **負荷バランス**: 各領域の計算負荷均等化

### 最適化手順
1. **初期分割**: 均等分割による基本性能確認
2. **負荷解析**: 各領域の計算負荷測定
3. **分割調整**: 負荷に応じた分割境界調整
4. **性能評価**: 最終的な性能評価

## 出力データ

分割処理に関する以下の項目が出力されます：
- 各領域の計算時間
- メモリ使用量
- 通信時間
- 負荷バランス指標
- 分割効率

## 関連データセット

- [COORDNT](COORDNT.md): 座標変換・日射計算
- [ROOM](ROOM.md): 室・ゾーン定義
- [OBS](OBS.md): 外部障害物
- [POLYGON](POLYGON.md): 複雑形状面

## 注意事項

1. **分割粒度**: 過度な分割による通信オーバーヘッド
2. **境界処理**: 分割境界での物理的連続性確保
3. **負荷バランス**: 計算負荷の不均等による性能低下
4. **メモリ制約**: 各領域のメモリ使用量制限
5. **数値精度**: 分割による数値誤差の蓄積